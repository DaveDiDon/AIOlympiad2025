<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Enhanced Playlist Insights</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        /* CSS Variables for Theming */
        :root {
            /* Light Theme Defaults */
            --bg-primary: #f0f4f8; /* Light Gray */
            --bg-secondary: #ffffff; /* White */
            --bg-section: #f8fafc; /* Slate-50 */
            --text-primary: #334155; /* Slate-700 */
            --text-secondary: #475569; /* Slate-600 */
            --text-header: #1e293b; /* Slate-800 */
            --text-accent: #4f46e5; /* Indigo-600 */
            --border-color: #e2e8f0; /* Gray-200 */
            --shadow-color-light: rgba(0, 0, 0, 0.1);
            --shadow-color-dark: rgba(0, 0, 0, 0.05);
            --shadow-inset-color: rgba(0, 0, 0, 0.06);

            /* Chart Colors */
            --chart-bar-songs: #60a5fa; /* Blue-400 */
            --chart-bar-songs-hover: #3b82f6; /* Blue-500 */
            --chart-bar-energy: #f87171; /* Red-400 */
            --chart-bar-energy-hover: #ef4444; /* Red-500 */
            --chart-bar-histogram: #8a2be2; /* BlueViolet */
            --chart-bar-histogram-hover: #6a0dad; /* Darker BlueViolet */
            --chart-axis-text: #475569; /* Slate-600 */
            --chart-grid: #cbd5e1; /* Slate-300 */

            /* Info Box Colors */
            --info-bg-green: #ecfdf5; /* Green-50 */
            --info-border-green: #a7f3d0; /* Green-200 */
            --info-text-green: #047857; /* Green-700 */
            --info-bg-yellow: #fffdf0; /* Yellow-50 */
            --info-border-yellow: #fde68a; /* Yellow-200 */
            --info-text-yellow: #b45309; /* Yellow-700 */
            --info-bg-purple: #f5f3ff; /* Purple-50 */
            --info-border-purple: #d8b4fe; /* Purple-200 */
            --info-text-purple: #7e22ce; /* Purple-700 */

            /* Button Colors */
            --btn-primary-bg: #2563eb; /* Blue-600 */
            --btn-primary-hover-bg: #1d4ed8; /* Blue-700 */
            --btn-danger-bg: #dc2626; /* Red-600 */
            --btn-danger-hover-bg: #b91c1c; /* Red-700 */
            --btn-secondary-bg: #d1d5db; /* Gray-300 */
            --btn-secondary-text: #374151; /* Gray-800 */
            --btn-secondary-hover-bg: #9ca3af; /* Gray-400 */

            /* Input/Table Colors */
            --input-border: #d1d5db; /* Gray-300 */
            --input-focus-ring: #3b82f6; /* Blue-500 */
            --table-header-bg: #e2e8f0; /* Gray-200 */
            --table-border: #e2e8f0; /* Gray-200 */
            --table-row-even-bg: #f8fafc; /* Slate-50 */

            /* Message Colors */
            --error-text: #dc2626; /* Red-600 */
            --upload-success-text: #16a34a; /* Green-600 */
        }

        /* Dark Mode Overrides */
        body.dark {
            --bg-primary: #1a202c; /* Dark Blue-Gray */
            --bg-secondary: #2d3748; /* Darker Blue-Gray */
            --bg-section: #28303e; /* Even darker for sections */
            --text-primary: #e2e8f0; /* Light Gray */
            --text-secondary: #a0aec0; /* Gray-400 */
            --text-header: #e2e8f0; /* Light Gray */
            --text-accent: #818cf8; /* Indigo-400 */
            --border-color: #4a5568; /* Gray-600 */
            --shadow-color-light: rgba(255, 255, 255, 0.05);
            --shadow-color-dark: rgba(255, 255, 255, 0.02);
            --shadow-inset-color: rgba(0, 0, 0, 0.2);

            /* Chart Colors */
            --chart-bar-songs: #4299e1; /* Blue-500 */
            --chart-bar-songs-hover: #3182ce; /* Blue-600 */
            --chart-bar-energy: #fc8181; /* Red-300 */
            --chart-bar-energy-hover: #e53e3e; /* Red-500 */
            --chart-bar-histogram: #b39ddb; /* Deep Purple-200 */
            --chart-bar-histogram-hover: #9575cd; /* Deep Purple-300 */
            --chart-axis-text: #a0aec0; /* Gray-400 */
            --chart-grid: #4a5568; /* Gray-600 */

            /* Info Box Colors */
            --info-bg-green: #2f4f4f; /* Darker Green */
            --info-border-green: #38a169; /* Green-600 */
            --info-text-green: #9ae6b4; /* Green-300 */
            --info-bg-yellow: #4a4020; /* Darker Yellow */
            --info-border-yellow: #d69e2e; /* Yellow-600 */
            --info-text-yellow: #f6ad55; /* Yellow-300 */
            --info-bg-purple: #3a245d; /* Darker Purple */
            --info-border-purple: #805ad5; /* Purple-600 */
            --info-text-purple: #d6bcfa; /* Purple-300 */

            /* Button Colors */
            --btn-primary-bg: #4c51bf; /* Indigo-700 */
            --btn-primary-hover-bg: #434190; /* Indigo-800 */
            --btn-danger-bg: #e53e3e; /* Red-500 */
            --btn-danger-hover-bg: #c53030; /* Red-600 */
            --btn-secondary-bg: #4a5568; /* Gray-600 */
            --btn-secondary-text: #e2e8f0; /* Light Gray */
            --btn-secondary-hover-bg: #64748b; /* Gray-500 */

            /* Input/Table Colors */
            --input-border: #4a5568; /* Gray-600 */
            --input-focus-ring: #63b3ed; /* Blue-300 */
            --table-header-bg: #4a5568; /* Gray-600 */
            --table-border: #4a5568; /* Gray-600 */
            --table-row-even-bg: #2d3748; /* Darker Blue-Gray */
        }

        /* Blue-Gold Theme Overrides */
        body.theme-blue-gold {
            --bg-primary: #0a1128; /* Deep Blue */
            --bg-secondary: #1b2a49; /* Slightly lighter blue */
            --bg-section: #20345a; /* Mid blue */
            --text-primary: #e0e0e0; /* Off-white */
            --text-secondary: #c0c0c0; /* Lighter gray */
            --text-header: #f0f0f0; /* White */
            --text-accent: #fcd34d; /* Amber-300 (Gold) */
            --border-color: #3a4b6f; /* Blue-gray border */
            --shadow-color-light: rgba(0, 0, 0, 0.2);
            --shadow-color-dark: rgba(0, 0, 0, 0.1);
            --shadow-inset-color: rgba(0, 0, 0, 0.25);

            /* Chart Colors */
            --chart-bar-songs: #6366f1; /* Indigo-500 */
            --chart-bar-songs-hover: #4f46e5; /* Indigo-600 */
            --chart-bar-energy: #fcd34d; /* Amber-300 */
            --chart-bar-energy-hover: #fbbf24; /* Amber-400 */
            --chart-bar-histogram: #8b5cf6; /* Violet-500 */
            --chart-bar-histogram-hover: #7c3aed; /* Violet-600 */
            --chart-axis-text: #c0c0c0; /* Light gray */
            --chart-grid: #3a4b6f; /* Blue-gray */

            /* Info Box Colors */
            --info-bg-green: #2c4a4a;
            --info-border-green: #48bb78;
            --info-text-green: #9ae6b4;
            --info-bg-yellow: #4a4020;
            --info-border-yellow: #d69e2e;
            --info-text-yellow: #f6ad55;
            --info-bg-purple: #3a245d;
            --info-border-purple: #805ad5;
            --info-text-purple: #d6bcfa;

            /* Button Colors */
            --btn-primary-bg: #fcd34d; /* Amber-300 */
            --btn-primary-hover-bg: #fbbf24; /* Amber-400 */
            --btn-danger-bg: #ef4444; /* Red-500 */
            --btn-danger-hover-bg: #dc2626; /* Red-600 */
            --btn-secondary-bg: #3a4b6f; /* Blue-gray */
            --btn-secondary-text: #e0e0e0;
            --btn-secondary-hover-bg: #4a5b80;

            /* Input/Table Colors */
            --input-border: #3a4b6f;
            --input-focus-ring: #fcd34d;
            --table-header-bg: #3a4b6f;
            --table-border: #3a4b6f;
            --table-row-even-bg: #1b2a49;
        }


        /* Apply CSS Variables */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            background-color: var(--bg-secondary);
            border-radius: 1.25rem;
            box-shadow: 0 10px 15px -3px var(--shadow-color-light), 0 4px 6px -2px var(--shadow-color-dark);
        }
        h1, h2, h3 {
            color: var(--text-header);
        }
        h1 {
            color: var(--text-accent);
        }
        h2 {
            color: var(--text-accent);
        }
        .chart-container-wrapper, .data-section-wrapper {
            background-color: var(--bg-section);
            box-shadow: inset 0 2px 4px 0 var(--shadow-inset-color);
        }
        .bar-songs {
            fill: var(--chart-bar-songs);
        }
        .bar-songs:hover {
            fill: var(--chart-bar-songs-hover);
        }
        .bar-energy {
            fill: var(--chart-bar-energy);
        }
        .bar-energy:hover {
            fill: var(--chart-bar-energy-hover);
        }
        .bar-histogram { /* New class for histogram bars */
            fill: var(--chart-bar-histogram);
        }
        .bar-histogram:hover {
            fill: var(--chart-bar-histogram-hover);
        }
        .axis text {
            fill: var(--chart-axis-text);
        }
        .axis line, .axis path {
            stroke: var(--chart-grid);
        }
        .input-field {
            border-color: var(--input-border);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        .input-field:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--input-focus-ring);
        }
        .btn-primary {
            background-color: var(--btn-primary-bg);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--btn-primary-hover-bg);
        }
        .btn-danger {
            background-color: var(--btn-danger-bg);
            color: white;
        }
        .btn-danger:hover {
            background-color: var(--btn-danger-hover-bg);
        }
        .btn-secondary {
            background-color: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
        }
        .btn-secondary:hover {
            background-color: var(--btn-secondary-hover-bg);
        }
        table {
            border-color: var(--table-border);
        }
        th, td {
            border-color: var(--table-border);
            color: var(--text-primary);
        }
        th {
            background-color: var(--table-header-bg);
        }
        tr:nth-child(even) {
            background-color: var(--table-row-even-bg);
        }
        .text-red-600 { /* Specific override for error message */
            color: var(--error-text);
        }
        .text-green-600 { /* Specific override for upload success message */
            color: var(--upload-success-text);
        }

        /* Info Box Specifics - using direct Tailwind classes for simplicity, but could be themed too */
        .p-6.bg-green-50 { background-color: var(--info-bg-green); border-color: var(--info-border-green); }
        .p-6.bg-green-50 .text-green-700 { color: var(--info-text-green); }
        .p-6.bg-yellow-50 { background-color: var(--info-bg-yellow); border-color: var(--info-border-yellow); }
        .p-6.bg-yellow-50 .text-yellow-700 { color: var(--info-text-yellow); }
        .p-6.bg-purple-50 { background-color: var(--info-bg-purple); border-color: var(--info-border-purple); }
        .p-6.bg-purple-50 .text-purple-700 { color: var(--info-text-purple); }
        .text-gray-600, .text-gray-500, .text-gray-800, .text-gray-700 {
            color: var(--text-secondary);
        }
        .text-gray-800 {
            color: var(--text-primary);
        }
        .text-gray-700 {
            color: var(--text-header);
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <header class="text-center mb-10 pb-6 border-b border-gray-200">
            <h1 class="text-4xl mb-4 text-indigo-700">My Enhanced Playlist Insights</h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                Dive into your music listening habits! Add your favorite songs below, or upload a CSV file, and this tool will analyze your playlist to show you your top artists, average energy levels, and how your music taste varies throughout the week.
            </p>
            <div class="mt-6 flex flex-col sm:flex-row justify-center items-center gap-4">
                <button id="darkModeToggle" class="btn-secondary flex items-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 00-.707-.293H15a1 1 0 000-2h-.586a1 1 0 00-.707.293l-.707.707a1 1 0 001.414 1.414l.707-.707zM10 15a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm-4 0a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1zm-2.12-10.607a1 1 0 00-.707-.293H5a1 1 0 000-2h-.586a1 1 0 00-.707.293l-.707.707a1 1 0 001.414 1.414l.707-.707z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Toggle Dark Mode</span>
                </button>
                <div class="relative">
                    <select id="themeSelect" class="btn-secondary py-2 pl-3 pr-8 rounded-lg appearance-none cursor-pointer">
                        <option value="default">Light Theme</option>
                        <option value="dark">Dark Theme</option>
                        <option value="theme-blue-gold">Blue-Gold Theme</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-200">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>
        </header>

        <section class="data-section-wrapper mb-10">
            <h2 class="text-2xl mb-6 text-center text-indigo-600">Upload Your Playlist (CSV)</h2>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-4">
                <input type="file" id="csvFileInput" accept=".csv" class="input-field p-2">
                <button id="uploadCsvButton" class="btn-primary">Upload & Analyze CSV</button>
            </div>
            <p id="uploadMessage" class="text-center mt-2"></p>
        </section>

        <section class="data-section-wrapper mb-10">
            <h2 class="text-2xl mb-6 text-center text-indigo-600">Manually Add Songs</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <input type="text" id="songInput" placeholder="Song Title" class="input-field">
                <input type="text" id="artistInput" placeholder="Artist Name" class="input-field">
                <input type="number" id="energyInput" placeholder="Energy (0.0 - 1.0)" step="0.1" min="0" max="1" class="input-field">
                <select id="dayInput" class="input-field">
                    <option value="">Select Day Played</option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                </select>
            </div>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="addSongButton" class="btn-primary">Add Song</button>
                <button id="clearAllDataButton" class="btn-danger">Clear All Playlist Data</button>
            </div>
            <p id="errorMessage" class="text-red-600 text-center mt-2 hidden"></p>
        </section>

        <section class="data-section-wrapper mb-10">
            <h2 class="text-2xl mb-6 text-center text-indigo-600">Your Current Playlist</h2>
            <div id="playlistTableContainer" class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg shadow-md">
                    <thead>
                        <tr>
                            <th>Song</th>
                            <th>Artist</th>
                            <th>Energy</th>
                            <th>Day Played</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="playlistTableBody">
                        </tbody>
                </table>
            </div>
            <p id="noSongsMessage" class="text-gray-500 text-center mt-4 hidden">Add some songs or upload a CSV to see your playlist here!</p>
        </section>


        <section class="mb-10">
            <h2 class="text-2xl mb-6 text-center text-indigo-600">Key Insights</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="p-6 bg-green-50 rounded-lg shadow-md border border-green-200">
                    <h3 class="text-xl font-semibold mb-3 text-green-700">Top Artist</h3>
                    <p id="topArtistResult" class="text-lg text-gray-800">No data available.</p>
                </div>
                <div class="p-6 bg-yellow-50 rounded-lg shadow-md border border-yellow-200">
                    <h3 class="text-xl font-semibold mb-3 text-yellow-700">Overall Playlist Energy</h3>
                    <p id="energyLevelResult" class="text-lg text-gray-800">No data available.</p>
                </div>
                <div class="p-6 bg-purple-50 rounded-lg shadow-md border border-purple-200">
                    <h3 class="text-xl font-semibold mb-3 text-purple-700">Most Listened Day</h3>
                    <p id="dailyMusicStatement" class="text-lg text-gray-800">No data available.</p>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-2xl mb-6 text-center text-indigo-600">Visual Breakdown of Your Habits</h2>

            <div class="chart-container-wrapper">
                <h3 class="text-xl font-semibold mb-4 text-center text-gray-700">Songs Played Per Day</h3>
                <div id="songs-per-day-chart" class="flex justify-center">
                    </div>
            </div>

            <div class="chart-container-wrapper">
                <h3 class="text-xl font-semibold mb-4 text-center text-gray-700">Average Energy Level Per Day</h3>
                <div id="energy-per-day-chart" class="flex justify-center">
                    </div>
            </div>

            <div class="chart-container-wrapper">
                <h3 class="text-xl font-semibold mb-4 text-center text-gray-700">Playlist Energy Distribution</h3>
                <div id="energy-distribution-chart" class="flex justify-center">
                    </div>
                <p class="text-sm text-gray-600 mt-4 text-center">
                    This chart shows how many songs in your playlist fall into different energy level ranges (e.g., 0.0-0.1, 0.1-0.2, etc.). It helps you understand the overall 'vibe' of your music collection.
                </p>
            </div>
        </section>
    </div>

    <div class="tooltip" style="opacity: 0;"></div>

    <script>
        // --- Global Variables and Data Storage ---
        const LOCAL_STORAGE_KEY = 'userPlaylist';
        const THEME_KEY = 'selectedTheme';
        let playlist = []; // This array will hold the current playlist data

        // Default expanded playlist data (used if localStorage is empty and no CSV uploaded)
        const default_playlist_data = [
            { Song: 'Save Your Tears', Artist: 'The Weeknd', Energy: 0.7, Day_Played: 'Monday' },
            { Song: 'Every Teardrop Is a Waterfall', Artist: 'Coldplay', Energy: 0.8, Day_Played: 'Tuesday' },
            { Song: 'Viva la Vida', Artist: 'Coldplay', Energy: 0.8, Day_Played: 'Wednesday' },
            { Song: 'HandClap', Artist: 'Fitz and The Tantrums', Energy: 1.0, Day_Played: 'Thursday' },
            { Song: 'Riptide', Artist: 'Vance Joy', Energy: 0.5, Day_Played: 'Friday' },
            { Song: 'Make You Mine', Artist: 'PUBLIC', Energy: 0.8, Day_Played: 'Saturday' },
            { Song: 'Out of My League', Artist: 'Fitz and The Tantrums', Energy: 0.9, Day_Played: 'Sunday' },
            { Song: 'A Sky Full of Stars', Artist: 'Coldplay', Energy: 0.9, Day_Played: 'Monday' },
            { Song: 'Blinding Lights', Artist: 'The Weeknd', Energy: 0.9, Day_Played: 'Tuesday' },
            { Song: 'The Less I Know The Better', Artist: 'Tame Impala', Energy: 0.6, Day_Played: 'Wednesday' },
            { Song: 'Fix You', Artist: 'Coldplay', Energy: 0.4, Day_Played': 'Thursday' },
            { Song: 'Mr. Brightside', Artist: 'The Killers', Energy: 0.9, Day_Played': 'Friday' },
            { Song: 'Watermelon Sugar', Artist: 'Harry Styles', Energy: 0.7, Day_Played': 'Saturday' },
            { Song: 'Sunflower', Artist: 'Post Malone', Energy: 0.8, Day_Played: 'Sunday' },
            { Song: 'Thunderstruck', Artist: 'AC/DC', Energy: 1.0, Day_Played: 'Monday' },
            { Song: 'Imagine', Artist: 'John Lennon', Energy: 0.3, Day_Played: 'Tuesday' },
            { Song: 'Don\'t Stop Believin\'', Artist: 'Journey', Energy: 0.9, Day_Played': 'Wednesday' },
            { Song: 'Lovely Day', Artist: 'Bill Withers', Energy: 0.6, Day_Played': 'Thursday' },
            { Song: 'Africa', Artist': 'Toto', Energy: 0.7, Day_Played': 'Friday' },
            { Song: 'Sweet Child o\' Mine', Artist: 'Guns N\' Roses', Energy: 0.9 }
        ];

        // Define the desired order of days for consistent plotting
        const daysOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        // --- DOM Elements ---
        const csvFileInput = document.getElementById('csvFileInput');
        const uploadCsvButton = document.getElementById('uploadCsvButton');
        const uploadMessage = document.getElementById('uploadMessage');

        const songInput = document.getElementById('songInput');
        const artistInput = document.getElementById('artistInput');
        const energyInput = document.getElementById('energyInput');
        const dayInput = document.getElementById('dayInput');
        const addSongButton = document.getElementById('addSongButton');
        const clearAllDataButton = document.getElementById('clearAllDataButton');
        const playlistTableBody = document.getElementById('playlistTableBody');
        const noSongsMessage = document.getElementById('noSongsMessage');
        const errorMessage = document.getElementById('errorMessage');

        const topArtistResult = document.getElementById('topArtistResult');
        const energyLevelResult = document.getElementById('energyLevelResult');
        const dailyMusicStatement = document.getElementById('dailyMusicStatement');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const themeSelect = document.getElementById('themeSelect');


        // --- Local Storage Functions ---
        function loadPlaylistFromLocalStorage() {
            const storedPlaylist = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedPlaylist) {
                playlist = JSON.parse(storedPlaylist);
            } else {
                playlist = [...default_playlist_data]; // Use default data if nothing in storage
            }
        }

        function savePlaylistToLocalStorage() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(playlist));
        }

        function loadThemePreference() {
            const savedTheme = localStorage.getItem(THEME_KEY) || 'default'; // Default to 'default' (light)
            setTheme(savedTheme, false); // Apply theme without saving again
            if (themeSelect) {
                themeSelect.value = savedTheme; // Set dropdown to saved theme
            }
        }

        function setTheme(themeName, save = true) {
            // Remove all existing theme classes
            document.body.classList.remove('dark', 'theme-blue-gold'); // Add more theme classes here as they are added

            // Apply the selected theme class
            if (themeName !== 'default') {
                document.body.classList.add(themeName);
            }

            // Update the dark mode toggle state if theme is dark/light
            if (themeName === 'dark') {
                darkModeToggle.querySelector('span').textContent = 'Toggle Light Mode';
            } else {
                darkModeToggle.querySelector('span').textContent = 'Toggle Dark Mode';
            }


            if (save) {
                localStorage.setItem(THEME_KEY, themeName);
            }
            // Re-draw charts to apply new colors if they use CSS variables
            if (playlist.length > 0) {
                drawSongsPerDayChart();
                drawEnergyPerDayChart();
                drawEnergyDistributionChart(); // Re-draw new chart as well
            }
        }

        // --- UI Update Functions ---
        function updateUI() {
            renderPlaylistTable();
            if (playlist.length > 0) {
                analyzeTopArtist();
                analyzeAverageEnergy();
                analyzeMostPlayedDay();
                drawSongsPerDayChart();
                drawEnergyPerDayChart();
                drawEnergyDistributionChart(); // Call new chart function
                hideNoDataMessages(false);
            } else {
                // Clear analysis results and charts if playlist is empty
                topArtistResult.textContent = "No data available.";
                energyLevelResult.textContent = "No data available.";
                dailyMusicStatement.textContent = "No data available.";
                d3.select("#songs-per-day-chart svg").remove();
                d3.select("#energy-per-day-chart svg").remove();
                d3.select("#energy-distribution-chart svg").remove(); // Clear new chart
                hideNoDataMessages(true);
            }
        }

        function hideNoDataMessages(show) {
             if (show) {
                 noSongsMessage.classList.remove('hidden');
                 document.getElementById('playlistTableContainer').classList.add('hidden');
             } else {
                 noSongsMessage.classList.add('hidden');
                 document.getElementById('playlistTableContainer').classList.remove('hidden');
             }
        }

        function showErrorMessage(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideErrorMessage() {
            errorMessage.classList.add('hidden');
        }

        function showUploadMessage(message, isError = false) {
            uploadMessage.textContent = message;
            uploadMessage.className = isError ? 'text-red-600 text-center mt-2' : 'text-green-600 text-center mt-2';
        }

        function clearUploadMessage() {
            uploadMessage.textContent = '';
            uploadMessage.className = 'text-center mt-2';
        }

        function renderPlaylistTable() {
            playlistTableBody.innerHTML = ''; // Clear existing rows
            if (playlist.length === 0) {
                hideNoDataMessages(true);
                return;
            } else {
                 hideNoDataMessages(false);
            }

            playlist.forEach((song, index) => {
                const row = playlistTableBody.insertRow();
                row.innerHTML = `
                    <td>${song.Song || 'N/A'}</td>
                    <td>${song.Artist || 'N/A'}</td>
                    <td>${(typeof song.Energy === 'number' ? song.Energy.toFixed(2) : 'N/A')}</td>
                    <td>${song.Day_Played || 'N/A'}</td>
                    <td>
                        <button class="btn-danger text-sm px-2 py-1" data-index="${index}">Delete</button>
                    </td>
                `;
            });

            // Add event listeners for delete buttons
            playlistTableBody.querySelectorAll('.btn-danger').forEach(button => {
                button.addEventListener('click', (event) => {
                    const indexToDelete = parseInt(event.target.dataset.index);
                    deleteSong(indexToDelete);
                });
            });
        }

        // --- Playlist Management Functions ---
        function addSong() {
            hideErrorMessage(); // Clear previous error messages

            const song = songInput.value.trim();
            const artist = artistInput.value.trim();
            const energy = parseFloat(energyInput.value);
            const day = dayInput.value;

            // Basic validation
            if (!song || !artist || isNaN(energy) || energy < 0 || energy > 1 || !day) {
                showErrorMessage('Please fill in all fields correctly. Energy must be between 0.0 and 1.0.');
                return;
            }

            const newSong = { Song: song, Artist: artist, Energy: energy, Day_Played: day };
            playlist.push(newSong);
            savePlaylistToLocalStorage();
            updateUI();

            // Clear input fields
            songInput.value = '';
            artistInput.value = '';
            energyInput.value = '';
            dayInput.value = ''; // Reset select to placeholder
        }

        function deleteSong(index) {
            if (confirm(`Are you sure you want to delete "${playlist[index].Song}"?`)) {
                playlist.splice(index, 1); // Remove song from array
                savePlaylistToLocalStorage();
                updateUI();
            }
        }

        function clearAllData() {
            if (confirm("Are you sure you want to clear ALL your playlist data? This cannot be undone!")) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                playlist = []; // Clear the in-memory playlist
                updateUI();
                alert("All playlist data has been cleared!");
            }
        }

        // --- CSV Upload Functions ---
        function parseCsv(csvString) {
            const lines = csvString.trim().split('\n');
            if (lines.length === 0) return [];

            const headers = lines[0].split(',').map(header => header.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(value => value.trim());
                if (values.length !== headers.length) {
                    console.warn(`Skipping malformed row: ${lines[i]}`);
                    continue; // Skip rows that don't match header count
                }
                const rowObject = {};
                headers.forEach((header, index) => {
                    rowObject[header] = values[index];
                });
                data.push(rowObject);
            }
            return data;
        }

        function processUploadedPlaylist(rawCsvData) {
            const processedPlaylist = [];
            const knownEnergyMap = {
                'Save Your Tears': 0.7, 'Every Teardrop Is a Waterfall': 0.8, 'Viva la Vida': 0.8,
                'HandClap': 1.0, 'Riptide': 0.5, 'Make You Mine': 0.8, 'Out of My League': 0.9,
                'A Sky Full of Stars': 0.9, 'Blinding Lights': 0.9, 'The Less I Know The Better': 0.6,
                'Fix You': 0.4, 'Mr. Brightside': 0.9, 'Watermelon Sugar': 0.7, 'Sunflower': 0.8,
                'Thunderstruck': 1.0, 'Imagine': 0.3, 'Don\'t Stop Believin\'': 0.9, 'Lovely Day': 0.6,
                'Africa': 0.7, 'Sweet Child o\' Mine': 0.9, 'Again': 0.85 // Added Again by YUI
            };

            rawCsvData.forEach(item => {
                const songTitle = item.Song ? item.Song.trim() : '';
                let artistName = item.Artist ? item.Artist.trim() : '';
                if (!artistName && item['Artist Name 1']) { // Check for 'Artist Name 1' if 'Artist' is missing
                    artistName = item['Artist Name 1'].trim();
                }
                let energyLevel = parseFloat(item.Energy);
                let dayPlayed = item.Day_Played ? item.Day_Played.trim() : '';

                // Guess energy if not provided or invalid
                if (isNaN(energyLevel) || energyLevel < 0 || energyLevel > 1) {
                    energyLevel = knownEnergyMap[songTitle] || parseFloat((Math.random() * (0.6) + 0.3).toFixed(2)); // Random between 0.3 and 0.9
                }

                // Assign random day if not provided or invalid
                if (!dayPlayed || !daysOrder.includes(dayPlayed)) {
                    dayPlayed = daysOrder[Math.floor(Math.random() * daysOrder.length)];
                }

                if (songTitle) { // Only add if song title is present
                    processedPlaylist.push({
                        Song: songTitle,
                        Artist: artistName || 'Unknown Artist',
                        Energy: energyLevel,
                        Day_Played: dayPlayed
                    });
                }
            });
            return processedPlaylist;
        }

        function handleCsvUpload() {
            clearUploadMessage();
            const file = csvFileInput.files[0];
            if (!file) {
                showUploadMessage('Please select a CSV file to upload.', true);
                return;
            }

            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const csvString = e.target.result;
                    const rawData = parseCsv(csvString);
                    const newPlaylist = processUploadedPlaylist(rawData);

                    if (newPlaylist.length === 0) {
                        showUploadMessage('The uploaded CSV file contains no valid song data.', true);
                        return;
                    }

                    playlist = newPlaylist; // Replace current playlist with uploaded data
                    savePlaylistToLocalStorage();
                    updateUI();
                    showUploadMessage(`Successfully uploaded ${newPlaylist.length} songs from CSV!`);
                } catch (error) {
                    console.error("Error processing CSV:", error);
                    showUploadMessage('Error processing CSV file. Please ensure it is correctly formatted.', true);
                }
            };

            reader.onerror = () => {
                showUploadMessage('Error reading file. Please try again.', true);
            };

            reader.readAsText(file);
        }


        // --- Analysis Functions (re-used) ---

        function analyzeTopArtist() {
            const artistCounts = {};
            playlist.forEach(item => {
                artistCounts[item.Artist] = (artistCounts[item.Artist] || 0) + 1;
            });

            let topArtist = 'N/A';
            let topArtistCount = 0;

            if (Object.keys(artistCounts).length > 0) {
                 // Convert to array of [artist, count] pairs to sort
                const sortedArtists = Object.entries(artistCounts).sort(([,countA], [,countB]) => countB - countA);
                topArtist = sortedArtists[0][0];
                topArtistCount = sortedArtists[0][1];
            }

            topArtistResult.textContent = `${topArtist} (with ${topArtistCount} songs)`;
        }

        function analyzeAverageEnergy() {
            if (playlist.length === 0) {
                energyLevelResult.textContent = "No data available.";
                return;
            }
            const totalEnergy = playlist.reduce((sum, item) => sum + item.Energy, 0);
            const averageEnergy = totalEnergy / playlist.length;

            let energyMessage = '';
            if (averageEnergy < 0.4) {
                energyMessage = "You're definitely a chill vibe listener.";
            } else if (averageEnergy > 0.6) {
                energyMessage = "Looks like you're ready to power through anything!";
            } else {
                energyMessage = "You've got a balanced mix of vibes going on!";
            }
            energyLevelResult.textContent = `${averageEnergy.toFixed(2)} - ${energyMessage}`;
        }

        function analyzeMostPlayedDay() {
            if (playlist.length === 0) {
                dailyMusicStatement.textContent = "No data available.";
                return;
            }
            const dayCounts = {};
            playlist.forEach(item => {
                dayCounts[item.Day_Played] = (dayCounts[item.Day_Played] || 0) + 1;
            });

            let mostPlayedDay = 'N/A';
            let maxPlays = 0;
            daysOrder.forEach(day => { // Iterate through ordered days to find max
                const count = dayCounts[day] || 0;
                if (count > maxPlays) {
                    maxPlays = count;
                    mostPlayedDay = day;
                }
            });

            dailyMusicStatement.textContent = `Most songs (${maxPlays}) were played on ${mostPlayedDay}.`;
        }

        // --- D3.js Charting Functions ---
        const tooltip = d3.select(".tooltip");

        function drawChart(containerId, data, xDomainAccessor, yDomainAccessor, yLabel, barColorClass, type = 'songs') {
            const container = document.getElementById(containerId);
            if (!container) return;
            d3.select(`#${containerId} svg`).remove(); // Clear existing SVG on resize or data update

            if (playlist.length === 0) { // Don't draw if no data
                return;
            }

            const margin = { top: 30, right: 30, bottom: 60, left: 50 };
            const containerWidth = container.offsetWidth;
            const width = Math.max(300, containerWidth - margin.left - margin.right); // Ensure min width
            const height = 350 - margin.top - margin.bottom;

            const svg = d3.select(`#${containerId}`)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // X axis
            const x = d3.scaleBand()
                .range([0, width])
                .domain(data.map(d => xDomainAccessor(d)))
                .padding(0.2);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end")
                .style("font-size", "0.9rem")
                .style("fill", "var(--chart-axis-text)"); /* Use CSS variable */

            // Y axis
            const yMax = d3.max(data, d => yDomainAccessor(d));
            const yDomainUpper = (type === 'energy') ? 1 : (yMax === 0 ? 1 : yMax + 1); // For songs, pad a bit, for energy max is 1
            const y = d3.scaleLinear()
                .domain([0, yDomainUpper])
                .range([height, 0]);

            svg.append("g")
                .call(d3.axisLeft(y).tickFormat(type === 'songs' ? d3.format("d") : d3.format(".1f")))
                .selectAll("text")
                .style("fill", "var(--chart-axis-text)"); /* Use CSS variable */

            // Bars
            svg.selectAll(".bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("x", d => x(xDomainAccessor(d)))
                .attr("y", d => y(yDomainAccessor(d)))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(yDomainAccessor(d)))
                .attr("class", `bar ${barColorClass} rounded-t-md`)
                .style("fill", `var(--${barColorClass})`) /* Use CSS variable for initial fill */
                .on("mouseover", function(event, d) {
                    d3.select(this).style("fill", `var(--${barColorClass}-hover)`); /* Use CSS variable for hover */
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`${xDomainAccessor(d)}: ${yDomainAccessor(d).toFixed(type === 'songs' ? 0 : 2)}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).style("fill", `var(--${barColorClass})`); /* Reset to initial CSS variable */
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Y-axis label
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("font-size", "0.9rem")
                .style("fill", "var(--chart-axis-text)") /* Use CSS variable */
                .text(yLabel);

            // Grid lines (optional, uncomment if desired)
            /*
            svg.append("g")
                .attr("class", "grid")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).tickSize(-height).tickFormat(""))
                .selectAll("line")
                .style("stroke", "var(--chart-grid)");
            */

            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(y).tickSize(-width).tickFormat(""))
                .selectAll("line")
                .style("stroke", "var(--chart-grid)");
        }

        function drawSongsPerDayChart() {
            const dayCounts = {};
            playlist.forEach(item => {
                dayCounts[item.Day_Played] = (dayCounts[item.Day_Played] || 0) + 1;
            });

            const chartData = daysOrder.map(day => ({
                day: day,
                count: dayCounts[day] || 0
            }));

            drawChart(
                'songs-per-day-chart',
                chartData,
                d => d.day,
                d => d.count,
                'Number of Songs Played',
                'bar-songs',
                'songs'
            );
        }

        function drawEnergyPerDayChart() {
            const energySumPerDay = {};
            const energyCountPerDay = {};

            playlist.forEach(item => {
                energySumPerDay[item.Day_Played] = (energySumPerDay[item.Day_Played] || 0) + item.Energy;
                energyCountPerDay[item.Day_Played] = (energyCountPerDay[item.Day_Played] || 0) + 1;
            });

            const chartData = daysOrder.map(day => ({
                day: day,
                averageEnergy: energyCountPerDay[day] > 0 ? energySumPerDay[day] / energyCountPerDay[day] : 0
            }));

            drawChart(
                'energy-per-day-chart',
                chartData,
                d => d.day,
                d => d.averageEnergy,
                'Average Energy Level (0-1)',
                'bar-energy',
                'energy'
            );
        }

        // New: Function to draw Energy Distribution Histogram
        function drawEnergyDistributionChart() {
            const container = document.getElementById('energy-distribution-chart');
            if (!container) return;
            d3.select(`#energy-distribution-chart svg`).remove();

            if (playlist.length === 0) {
                return;
            }

            const margin = { top: 30, right: 30, bottom: 60, left: 50 };
            const containerWidth = container.offsetWidth;
            const width = Math.max(300, containerWidth - margin.left - margin.right);
            const height = 350 - margin.top - margin.bottom;

            const svg = d3.select(`#energy-distribution-chart`)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Create histogram bins
            const histogram = d3.histogram()
                .value(d => d.Energy)
                .domain([0, 1]) // Energy levels are 0 to 1
                .thresholds(d3.range(0, 1.1, 0.1)); // Bins from 0 to 1, in 0.1 increments

            const bins = histogram(playlist);

            // X axis: Bin ranges
            const x = d3.scaleBand()
                .range([0, width])
                .domain(bins.map(d => `${d.x0.toFixed(1)}-${d.x1.toFixed(1)}`))
                .padding(0.1);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end")
                .style("font-size", "0.9rem")
                .style("fill", "var(--chart-axis-text)");

            // Y axis: Count of songs
            const y = d3.scaleLinear()
                .domain([0, d3.max(bins, d => d.length) + 1]) // +1 for padding
                .range([height, 0]);

            svg.append("g")
                .call(d3.axisLeft(y).tickFormat(d3.format("d")))
                .selectAll("text")
                .style("fill", "var(--chart-axis-text)");

            // Bars
            svg.selectAll(".bar-histogram")
                .data(bins)
                .enter()
                .append("rect")
                .attr("x", d => x(`${d.x0.toFixed(1)}-${d.x1.toFixed(1)}`))
                .attr("y", d => y(d.length))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.length))
                .attr("class", "bar bar-histogram rounded-t-md")
                .style("fill", "var(--chart-bar-histogram)")
                .on("mouseover", function(event, d) {
                    d3.select(this).style("fill", "var(--chart-bar-histogram-hover)");
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`Energy: ${d.x0.toFixed(1)}-${d.x1.toFixed(1)}<br>Songs: ${d.length}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).style("fill", "var(--chart-bar-histogram)");
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Y-axis label
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("font-size", "0.9rem")
                .style("fill", "var(--chart-axis-text)")
                .text("Number of Songs");

            // X-axis label
            svg.append("text")
                .attr("transform", `translate(${width / 2}, ${height + margin.bottom - 10})`)
                .style("text-anchor", "middle")
                .style("font-size", "0.9rem")
                .style("fill", "var(--chart-axis-text)")
                .text("Energy Level Range");

            // Grid lines
            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(y).tickSize(-width).tickFormat(""))
                .selectAll("line")
                .style("stroke", "var(--chart-grid)");
        }


        // --- Initial Load and Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            loadThemePreference(); // Load theme preference before loading playlist
            loadPlaylistFromLocalStorage(); // Load data first
            updateUI(); // Then update the UI based on loaded data

            addSongButton.addEventListener('click', addSong);
            clearAllDataButton.addEventListener('click', clearAllData);
            uploadCsvButton.addEventListener('click', handleCsvUpload);
            darkModeToggle.addEventListener('click', toggleDarkMode); // Dark mode toggle listener
            themeSelect.addEventListener('change', (event) => { // New theme select listener
                setTheme(event.target.value);
            });

            // Redraw charts on window resize for responsiveness
            window.addEventListener('resize', () => {
                // Only redraw charts, as other UI elements don't need resize handling
                if (playlist.length > 0) {
                    drawSongsPerDayChart();
                    drawEnergyPerDayChart();
                    drawEnergyDistributionChart(); // Re-draw new chart as well
                }
            });
        });
    </script>
</body>
</html>
