<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Enhanced Playlist Insights</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light Gray */
            color: #334155; /* Slate-700 */
        }
        .container {
            max-width: 96%; /* Slightly wider container */
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 1.25rem; /* rounded-2xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Larger shadow */
        }
        h1, h2, h3 {
            color: #1e293b; /* Slate-800 */
            font-weight: 700; /* font-bold */
        }
        .chart-container-wrapper, .data-section-wrapper {
            background-color: #f8fafc; /* Slate-50 */
            padding: 1.5rem;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); /* Inner shadow */
            margin-bottom: 2rem;
        }
        .bar-songs {
            fill: #60a5fa; /* blue-400 */
            transition: fill 0.2s ease-in-out;
        }
        .bar-songs:hover {
            fill: #3b82f6; /* blue-500 */
        }
        .bar-energy {
            fill: #f87171; /* red-400 */
            transition: fill 0.2s ease-in-out;
        }
        .bar-energy:hover {
            fill: #ef4444; /* red-500 */
        }
        .bar-histogram { /* NEW: Style for histogram bars */
            fill: #8a2be2; /* BlueViolet */
            transition: fill 0.2s ease-in-out;
        }
        .bar-histogram:hover { /* NEW: Hover style for histogram bars */
            fill: #6a0dad; /* Darker BlueViolet */
        }
        .axis text {
            font-size: 0.875rem; /* text-sm */
            fill: #475569; /* slate-600 */
        }
        .axis line, .axis path {
            stroke: #cbd5e1; /* slate-300 */
            shape-rendering: crispEdges;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 0.375rem; /* rounded-md */
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.875rem;
            z-index: 1000; /* Ensure tooltip is on top */
        }
        .input-field {
            @apply px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .btn-primary {
            @apply px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .btn-danger {
            @apply px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500;
        }
        .btn-secondary {
            @apply px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            border: 1px solid #e2e8f0; /* Gray-200 */
            padding: 0.75rem;
            text-align: left;
        }
        th {
            background-color: #e2e8f0; /* Gray-200 */
            font-weight: 600;
        }
        tr:nth-child(even) {
            background-color: #f8fafc; /* Slate-50 */
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <header class="text-center mb-10 pb-6 border-b border-gray-200">
            <h1 class="text-4xl mb-4 text-indigo-700">My Enhanced Playlist Insights</h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                Dive into your music listening habits! Add your favorite songs below, or upload a CSV file, and this tool will analyze your playlist to show you your top artists, average energy levels, and how your music taste varies throughout the week.
            </p>
        </header>

        <section class="data-section-wrapper mb-10">
            <h2 class="text-2xl mb-6 text-center text-indigo-600">Upload Your Playlist (CSV)</h2>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-4">
                <input type="file" id="csvFileInput" accept=".csv" class="input-field p-2">
                <button id="uploadCsvButton" class="btn-primary">Upload & Analyze CSV</button>
            </div>
            <p id="uploadMessage" class="text-center mt-2"></p>
        </section>

        <section class="data-section-wrapper mb-10">
            <h2 class="text-2xl mb-6 text-center text-indigo-600">Manually Add Songs</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <input type="text" id="songInput" placeholder="Song Title" class="input-field">
                <input type="text" id="artistInput" placeholder="Artist Name" class="input-field">
                <input type="number" id="energyInput" placeholder="Energy (0.0 - 1.0)" step="0.1" min="0" max="1" class="input-field">
                <select id="dayInput" class="input-field">
                    <option value="">Select Day Played</option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                </select>
            </div>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="addSongButton" class="btn-primary">Add Song</button>
                <button id="clearAllDataButton" class="btn-danger">Clear All Playlist Data</button>
            </div>
            <p id="errorMessage" class="text-red-600 text-center mt-2 hidden"></p>
        </section>

        <section class="data-section-wrapper mb-10">
            <h2 class="text-2xl mb-6 text-center text-indigo-600">Your Current Playlist</h2>
            <div id="playlistTableContainer" class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg shadow-md">
                    <thead>
                        <tr>
                            <th>Song</th>
                            <th>Artist</th>
                            <th>Energy</th>
                            <th>Day Played</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="playlistTableBody">
                        </tbody>
                </table>
            </div>
            <p id="noSongsMessage" class="text-gray-500 text-center mt-4 hidden">Add some songs or upload a CSV to see your playlist here!</p>
        </section>


        <section class="mb-10">
            <h2 class="text-2xl mb-6 text-center text-indigo-600">Key Insights</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="p-6 bg-green-50 rounded-lg shadow-md border border-green-200">
                    <h3 class="text-xl font-semibold mb-3 text-green-700">Top Artist</h3>
                    <p id="topArtistResult" class="text-lg text-gray-800">No data available.</p>
                </div>
                <div class="p-6 bg-yellow-50 rounded-lg shadow-md border border-yellow-200">
                    <h3 class="text-xl font-semibold mb-3 text-yellow-700">Overall Playlist Energy</h3>
                    <p id="energyLevelResult" class="text-lg text-gray-800">No data available.</p>
                </div>
                <div class="p-6 bg-purple-50 rounded-lg shadow-md border border-purple-200">
                    <h3 class="text-xl font-semibold mb-3 text-purple-700">Most Listened Day</h3>
                    <p id="dailyMusicStatement" class="text-lg text-gray-800">No data available.</p>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-2xl mb-6 text-center text-indigo-600">Visual Breakdown of Your Habits</h2>

            <div class="chart-container-wrapper">
                <h3 class="text-xl font-semibold mb-4 text-center text-gray-700">Songs Played Per Day</h3>
                <div id="songs-per-day-chart" class="flex justify-center">
                    </div>
            </div>

            <div class="chart-container-wrapper">
                <h3 class="text-xl font-semibold mb-4 text-center text-gray-700">Average Energy Level Per Day</h3>
                <div id="energy-per-day-chart" class="flex justify-center">
                    </div>
            </div>

            <div class="chart-container-wrapper">
                <h3 class="text-xl font-semibold mb-4 text-center text-gray-700">Playlist Energy Distribution</h3>
                <div id="energy-distribution-chart" class="flex justify-center">
                    </div>
                <p class="text-sm text-gray-600 mt-4 text-center">
                    This chart shows how many songs in your playlist fall into different energy level ranges (e.g., 0.0-0.1, 0.1-0.2, etc.). It helps you understand the overall 'vibe' of your music collection.
                </p>
            </div>
        </section>
    </div>

    <div class="tooltip" style="opacity: 0;"></div>

    <script>
        // --- Global Variables and Data Storage ---
        const LOCAL_STORAGE_KEY = 'userPlaylist';
        let playlist = []; // This array will hold the current playlist data

        // Default expanded playlist data (removed as per request)
        // const default_playlist_data = [ ... ];

        // Define the desired order of days for consistent plotting
        const daysOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        // --- DOM Elements ---
        const csvFileInput = document.getElementById('csvFileInput');
        const uploadCsvButton = document.getElementById('uploadCsvButton');
        const uploadMessage = document.getElementById('uploadMessage');

        const songInput = document.getElementById('songInput');
        const artistInput = document.getElementById('artistInput');
        const energyInput = document.getElementById('energyInput');
        const dayInput = document.getElementById('dayInput');
        const addSongButton = document.getElementById('addSongButton');
        const clearAllDataButton = document.getElementById('clearAllDataButton');
        const playlistTableBody = document.getElementById('playlistTableBody');
        const noSongsMessage = document.getElementById('noSongsMessage');
        const errorMessage = document.getElementById('errorMessage');

        const topArtistResult = document.getElementById('topArtistResult');
        const energyLevelResult = document.getElementById('energyLevelResult');
        const dailyMusicStatement = document.getElementById('dailyMusicStatement');


        // --- Local Storage Functions ---
        function loadPlaylistFromLocalStorage() {
            const storedPlaylist = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedPlaylist) {
                playlist = JSON.parse(storedPlaylist);
            } else {
                playlist = []; // Initialize as empty if no stored data
            }
        }

        function savePlaylistToLocalStorage() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(playlist));
        }

        // --- UI Update Functions ---
        function updateUI() {
            renderPlaylistTable();
            if (playlist.length > 0) {
                analyzeTopArtist();
                analyzeAverageEnergy();
                analyzeMostPlayedDay();
                drawSongsPerDayChart();
                drawEnergyPerDayChart();
                drawEnergyDistributionChart(); // Call the energy distribution chart function
                hideNoDataMessages(false);
            } else {
                // Clear analysis results and charts if playlist is empty
                topArtistResult.textContent = "No data available.";
                energyLevelResult.textContent = "No data available.";
                dailyMusicStatement.textContent = "No data available.";
                d3.select("#songs-per-day-chart svg").remove();
                d3.select("#energy-per-day-chart svg").remove();
                d3.select("#energy-distribution-chart svg").remove(); // Clear energy distribution chart
                hideNoDataMessages(true);
            }
        }

        function hideNoDataMessages(show) {
             if (show) {
                 noSongsMessage.classList.remove('hidden');
                 document.getElementById('playlistTableContainer').classList.add('hidden');
             } else {
                 noSongsMessage.classList.add('hidden');
                 document.getElementById('playlistTableContainer').classList.remove('hidden');
             }
        }

        function showErrorMessage(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideErrorMessage() {
            errorMessage.classList.add('hidden');
        }

        function showUploadMessage(message, isError = false) {
            uploadMessage.textContent = message;
            uploadMessage.className = isError ? 'text-red-600 text-center mt-2' : 'text-green-600 text-center mt-2';
        }

        function clearUploadMessage() {
            uploadMessage.textContent = '';
            uploadMessage.className = 'text-center mt-2';
        }

        function renderPlaylistTable() {
            playlistTableBody.innerHTML = ''; // Clear existing rows
            if (playlist.length === 0) {
                hideNoDataMessages(true);
                return;
            } else {
                 hideNoDataMessages(false);
            }

            playlist.forEach((song, index) => {
                const row = playlistTableBody.insertRow();
                row.innerHTML = `
                    <td>${song.Song || 'N/A'}</td>
                    <td>${song.Artist || 'N/A'}</td>
                    <td>${(typeof song.Energy === 'number' ? song.Energy.toFixed(2) : 'N/A')}</td>
                    <td>${song.Day_Played || 'N/A'}</td>
                    <td>
                        <button class="btn-danger text-sm px-2 py-1" data-index="${index}">Delete</button>
                    </td>
                `;
            });

            // Add event listeners for delete buttons
            playlistTableBody.querySelectorAll('.btn-danger').forEach(button => {
                button.addEventListener('click', (event) => {
                    const indexToDelete = parseInt(event.target.dataset.index);
                    deleteSong(indexToDelete);
                });
            });
        }

        // --- Playlist Management Functions ---
        function addSong() {
            hideErrorMessage(); // Clear previous error messages

            const song = songInput.value.trim();
            const artist = artistInput.value.trim();
            const energy = parseFloat(energyInput.value);
            const day = dayInput.value;

            // Basic validation
            if (!song || !artist || isNaN(energy) || energy < 0 || energy > 1 || !day) {
                showErrorMessage('Please fill in all fields correctly. Energy must be between 0.0 and 1.0.');
                return;
            }

            const newSong = { Song: song, Artist: artist, Energy: energy, Day_Played: day };
            playlist.push(newSong);
            savePlaylistToLocalStorage();
            updateUI();

            // Clear input fields
            songInput.value = '';
            artistInput.value = '';
            energyInput.value = '';
            dayInput.value = ''; // Reset select to placeholder
        }

        function deleteSong(index) {
            if (confirm(`Are you sure you want to delete "${playlist[index].Song}"?`)) {
                playlist.splice(index, 1); // Remove song from array
                savePlaylistToLocalStorage();
                updateUI();
            }
        }

        function clearAllData() {
            if (confirm("Are you sure you want to clear ALL your playlist data? This cannot be undone!")) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                playlist = []; // Clear the in-memory playlist
                updateUI();
                alert("All playlist data has been cleared!");
            }
        }

        // --- CSV Upload Functions ---
        function parseCsv(csvString) {
            const lines = csvString.trim().split('\n');
            if (lines.length === 0) return [];

            const headers = lines[0].split(',').map(header => header.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(value => value.trim());
                if (values.length !== headers.length) {
                    console.warn(`Skipping malformed row: ${lines[i]}`);
                    continue; // Skip rows that don't match header count
                }
                const rowObject = {};
                headers.forEach((header, index) => {
                    rowObject[header] = values[index];
                });
                data.push(rowObject);
            }
            return data;
        }

        function processUploadedPlaylist(rawCsvData) {
            const processedPlaylist = [];
            const knownEnergyMap = {
                'Save Your Tears': 0.7, 'Every Teardrop Is a Waterfall': 0.8, 'Viva la Vida': 0.8,
                'HandClap': 1.0, 'Riptide': 0.5, 'Make You Mine': 0.8, 'Out of My League': 0.9,
                'A Sky Full of Stars': 0.9, 'Blinding Lights': 0.9, 'The Less I Know The Better': 0.6,
                'Fix You': 0.4, 'Mr. Brightside': 0.9, 'Watermelon Sugar': 0.7, 'Sunflower': 0.8,
                'Thunderstruck': 1.0, 'Imagine': 0.3, 'Don\'t Stop Believin\'': 0.9, 'Lovely Day': 0.6,
                'Africa': 0.7, 'Sweet Child o\' Mine': 0.9, 'Again': 0.85 // Added Again by YUI
            };

            rawCsvData.forEach(item => {
                const songTitle = item.Song ? item.Song.trim() : '';
                let artistName = item.Artist ? item.Artist.trim() : '';
                if (!artistName && item['Artist Name 1']) { // Check for 'Artist Name 1' if 'Artist' is missing
                    artistName = item['Artist Name 1'].trim();
                }
                let energyLevel = parseFloat(item.Energy);
                let dayPlayed = item.Day_Played ? item.Day_Played.trim() : '';

                // Guess energy if not provided or invalid
                if (isNaN(energyLevel) || energyLevel < 0 || energyLevel > 1) {
                    energyLevel = knownEnergyMap[songTitle] || parseFloat((Math.random() * (0.6) + 0.3).toFixed(2)); // Random between 0.3 and 0.9
                }

                // Assign random day if not provided or invalid
                if (!dayPlayed || !daysOrder.includes(dayPlayed)) {
                    dayPlayed = daysOrder[Math.floor(Math.random() * daysOrder.length)];
                }

                if (songTitle) { // Only add if song title is present
                    processedPlaylist.push({
                        Song: songTitle,
                        Artist: artistName || 'Unknown Artist',
                        Energy: energyLevel,
                        Day_Played: dayPlayed
                    });
                }
            });
            return processedPlaylist;
        }

        function handleCsvUpload() {
            clearUploadMessage();
            const file = csvFileInput.files[0];
            if (!file) {
                showUploadMessage('Please select a CSV file to upload.', true);
                return;
            }

            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const csvString = e.target.result;
                    const rawData = parseCsv(csvString);
                    const newPlaylist = processUploadedPlaylist(rawData);

                    if (newPlaylist.length === 0) {
                        showUploadMessage('The uploaded CSV file contains no valid song data.', true);
                        return;
                    }

                    playlist = newPlaylist; // Replace current playlist with uploaded data
                    savePlaylistToLocalStorage();
                    updateUI();
                    showUploadMessage(`Successfully uploaded ${newPlaylist.length} songs from CSV!`);
                } catch (error) {
                    console.error("Error processing CSV:", error);
                    showUploadMessage('Error processing CSV file. Please ensure it is correctly formatted.', true);
                }
            };

            reader.onerror = () => {
                showUploadMessage('Error reading file. Please try again.', true);
            };

            reader.readAsText(file);
        }


        // --- Analysis Functions (re-used) ---

        function analyzeTopArtist() {
            const artistCounts = {};
            playlist.forEach(item => {
                artistCounts[item.Artist] = (artistCounts[item.Artist] || 0) + 1;
            });

            let topArtist = 'N/A';
            let topArtistCount = 0;

            if (Object.keys(artistCounts).length > 0) {
                 // Convert to array of [artist, count] pairs to sort
                const sortedArtists = Object.entries(artistCounts).sort(([,countA], [,countB]) => countB - countA);
                topArtist = sortedArtists[0][0];
                topArtistCount = sortedArtists[0][1];
            }

            topArtistResult.textContent = `${topArtist} (with ${topArtistCount} songs)`;
        }

        function analyzeAverageEnergy() {
            if (playlist.length === 0) {
                energyLevelResult.textContent = "No data available.";
                return;
            }
            const totalEnergy = playlist.reduce((sum, item) => sum + item.Energy, 0);
            const averageEnergy = totalEnergy / playlist.length;

            let energyMessage = '';
            if (averageEnergy < 0.4) {
                energyMessage = "You're definitely a chill vibe listener.";
            } else if (averageEnergy > 0.6) {
                energyMessage = "Looks like you're ready to power through anything!";
            } else {
                energyMessage = "You've got a balanced mix of vibes going on!";
            }
            energyLevelResult.textContent = `${averageEnergy.toFixed(2)} - ${energyMessage}`;
        }

        function analyzeMostPlayedDay() {
            if (playlist.length === 0) {
                dailyMusicStatement.textContent = "No data available.";
                return;
            }
            const dayCounts = {};
            playlist.forEach(item => {
                dayCounts[item.Day_Played] = (dayCounts[item.Day_Played] || 0) + 1;
            });

            let mostPlayedDay = 'N/A';
            let maxPlays = 0;
            daysOrder.forEach(day => { // Iterate through ordered days to find max
                const count = dayCounts[day] || 0;
                if (count > maxPlays) {
                    maxPlays = count;
                    mostPlayedDay = day;
                }
            });

            dailyMusicStatement.textContent = `Most songs (${maxPlays}) were played on ${mostPlayedDay}.`;
        }

        // --- D3.js Charting Functions ---
        const tooltip = d3.select(".tooltip");

        function drawChart(containerId, data, xDomainAccessor, yDomainAccessor, yLabel, barColorClass, type = 'songs') {
            const container = document.getElementById(containerId);
            if (!container) return;
            d3.select(`#${containerId} svg`).remove(); // Clear existing SVG on resize or data update

            if (playlist.length === 0) { // Don't draw if no data
                return;
            }

            const margin = { top: 30, right: 30, bottom: 60, left: 50 };
            const containerWidth = container.offsetWidth;
            const width = Math.max(300, containerWidth - margin.left - margin.right); // Ensure min width
            const height = 350 - margin.top - margin.bottom;

            const svg = d3.select(`#${containerId}`)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // X axis
            const x = d3.scaleBand()
                .range([0, width])
                .domain(data.map(d => xDomainAccessor(d)))
                .padding(0.2);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end")
                .style("font-size", "0.9rem")
                .style("fill", "#475569"); /* Use hardcoded color as CSS variables not in this version */

            // Y axis
            const yMax = d3.max(data, d => yDomainAccessor(d));
            const yDomainUpper = (type === 'energy') ? 1 : (yMax === 0 ? 1 : yMax + 1); // For songs, pad a bit, for energy max is 1
            const y = d3.scaleLinear()
                .domain([0, yDomainUpper])
                .range([height, 0]);

            svg.append("g")
                .call(d3.axisLeft(y).tickFormat(type === 'songs' ? d3.format("d") : d3.format(".1f")))
                .selectAll("text")
                .style("fill", "#475569"); /* Use hardcoded color as CSS variables not in this version */

            // Bars
            svg.selectAll(".bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("x", d => x(xDomainAccessor(d)))
                .attr("y", d => y(yDomainAccessor(d)))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(yDomainAccessor(d)))
                .attr("class", `bar ${barColorClass} rounded-t-md`)
                .on("mouseover", function(event, d) {
                    d3.select(this).style("fill", d3.rgb(d3.select(this).style("fill")).darker(0.5));
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`${xDomainAccessor(d)}: ${yDomainAccessor(d).toFixed(type === 'songs' ? 0 : 2)}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).style("fill", null);
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Y-axis label
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("font-size", "0.9rem")
                .style("fill", "#475569") /* Use hardcoded color as CSS variables not in this version */
                .text(yLabel);

            // Grid lines (optional, uncomment if desired)
            /*
            svg.append("g")
                .attr("class", "grid")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).tickSize(-height).tickFormat(""))
                .selectAll("line")
                .style("stroke", "#cbd5e1");
            */

            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(y).tickSize(-width).tickFormat(""))
                .selectAll("line")
                .style("stroke", "#cbd5e1");
        }

        function drawSongsPerDayChart() {
            const dayCounts = {};
            playlist.forEach(item => {
                dayCounts[item.Day_Played] = (dayCounts[item.Day_Played] || 0) + 1;
            });

            const chartData = daysOrder.map(day => ({
                day: day,
                count: dayCounts[day] || 0
            }));

            drawChart(
                'songs-per-day-chart',
                chartData,
                d => d.day,
                d => d.count,
                'Number of Songs Played',
                'bar-songs',
                'songs'
            );
        }

        function drawEnergyPerDayChart() {
            const energySumPerDay = {};
            const energyCountPerDay = {};

            playlist.forEach(item => {
                energySumPerDay[item.Day_Played] = (energySumPerDay[item.Day_Played] || 0) + item.Energy;
                energyCountPerDay[item.Day_Played] = (energyCountPerDay[item.Day_Played] || 0) + 1;
            });

            const chartData = daysOrder.map(day => ({
                day: day,
                averageEnergy: energyCountPerDay[day] > 0 ? energySumPerDay[day] / energyCountPerDay[day] : 0
            }));

            drawChart(
                'energy-per-day-chart',
                chartData,
                d => d.day,
                d => d.averageEnergy,
                'Average Energy Level (0-1)',
                'bar-energy',
                'energy'
            );
        }

        // NEW: Function to draw Energy Distribution Histogram
        function drawEnergyDistributionChart() {
            const container = document.getElementById('energy-distribution-chart');
            if (!container) return;
            d3.select(`#energy-distribution-chart svg`).remove();

            if (playlist.length === 0) {
                return;
            }

            const margin = { top: 30, right: 30, bottom: 60, left: 50 };
            const containerWidth = container.offsetWidth;
            const width = Math.max(300, containerWidth - margin.left - margin.right);
            const height = 350 - margin.top - margin.bottom;

            const svg = d3.select(`#energy-distribution-chart`)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Create histogram bins
            const histogram = d3.histogram()
                .value(d => d.Energy)
                .domain([0, 1]) // Energy levels are 0 to 1
                .thresholds(d3.range(0, 1.1, 0.1)); // Bins from 0 to 1, in 0.1 increments

            const bins = histogram(playlist);

            // X axis: Bin ranges
            const x = d3.scaleBand()
                .range([0, width])
                .domain(bins.map(d => `${d.x0.toFixed(1)}-${d.x1.toFixed(1)}`))
                .padding(0.1);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end")
                .style("font-size", "0.9rem")
                .style("fill", "#475569"); /* Use hardcoded color */

            // Y axis: Count of songs
            const y = d3.scaleLinear()
                .domain([0, d3.max(bins, d => d.length) + 1]) // +1 for padding
                .range([height, 0]);

            svg.append("g")
                .call(d3.axisLeft(y).tickFormat(d3.format("d")))
                .selectAll("text")
                .style("fill", "#475569"); /* Use hardcoded color */

            // Bars
            svg.selectAll(".bar-histogram")
                .data(bins)
                .enter()
                .append("rect")
                .attr("x", d => x(`${d.x0.toFixed(1)}-${d.x1.toFixed(1)}`))
                .attr("y", d => y(d.length))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.length))
                .attr("class", "bar bar-histogram rounded-t-md")
                .on("mouseover", function(event, d) {
                    d3.select(this).style("fill", d3.rgb(d3.select(this).style("fill")).darker(0.5));
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`Energy: ${d.x0.toFixed(1)}-${d.x1.toFixed(1)}<br>Songs: ${d.length}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).style("fill", null);
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Y-axis label
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("font-size", "0.9rem")
                .style("fill", "#475569")
                .text("Number of Songs");

            // X-axis label
            svg.append("text")
                .attr("transform", `translate(${width / 2}, ${height + margin.bottom - 10})`)
                .style("text-anchor", "middle")
                .style("font-size", "0.9rem")
                .style("fill", "#475569")
                .text("Energy Level Range");

            // Grid lines
            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(y).tickSize(-width).tickFormat(""))
                .selectAll("line")
                .style("stroke", "#cbd5e1");
        }


        // --- Initial Load and Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            loadPlaylistFromLocalStorage(); // Load data first
            updateUI(); // Then update the UI based on loaded data

            addSongButton.addEventListener('click', addSong);
            clearAllDataButton.addEventListener('click', clearAllData);
            uploadCsvButton.addEventListener('click', handleCsvUpload);

            // Redraw charts on window resize for responsiveness
            window.addEventListener('resize', () => {
                // Only redraw charts, as other UI elements don't need resize handling
                if (playlist.length > 0) {
                    drawSongsPerDayChart();
                    drawEnergyPerDayChart();
                    drawEnergyDistributionChart(); // NEW: Re-draw new chart as well
                }
            });
        });
    </script>
</body>
</html>
